<!doctype html><html lang=ja><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="grimoh"><meta name=generator content="Hugo 0.63.2"><title>Terraform backend の管理</title><link rel="shortcut icon" href=https://grimoh.com/images/favicon.ico><link rel=stylesheet href=https://grimoh.com/css/style.css><link rel=stylesheet href=https://grimoh.com/css/highlight.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css><link href=https://grimoh.com/index.xml rel=alternate type=application/rss+xml title=Grimoh><meta property="og:title" content="Terraform backend の管理"><meta property="og:description" content="Terraform backend を S3(+DynamoDB) で作成した時の管理について紹介します"><meta property="og:type" content="article"><meta property="og:url" content="https://grimoh.com/post/terraform-backend/"><meta property="article:published_time" content="2019-10-06T22:03:23+09:00"><meta property="article:modified_time" content="2020-02-01T22:03:23+09:00"><meta itemprop=name content="Terraform backend の管理"><meta itemprop=description content="Terraform backend を S3(+DynamoDB) で作成した時の管理について紹介します"><meta itemprop=datePublished content="2019-10-06T22:03:23+09:00"><meta itemprop=dateModified content="2020-02-01T22:03:23+09:00"><meta itemprop=wordCount content="47"><meta itemprop=keywords content="Terraform,AWS,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Terraform backend の管理"><meta name=twitter:description content="Terraform backend を S3(+DynamoDB) で作成した時の管理について紹介します"><meta name=twitter:site content="@https://www.twitter.com/grim0h"></head><body><nav class=main-nav><a href=https://grimoh.com/><span class=arrow>←</span>HOME</a>
<a class=cta href=https://grimoh.com/index.xml>Subscribe</a></nav><section id=wrapper><article class=post><header><h1>Terraform backend の管理</h1><h2 class=subtitle>Terraform backend を S3(+DynamoDB) で作成した時の管理について紹介します</h2><h2 class=headline>October 6, 2019<br><a href=https://grimoh.com/tags/terraform>Terraform</a>
<a href=https://grimoh.com/tags/aws>AWS</a></h2></header><section id=post-body><p><img src=../../images/terraform_backend.png alt="terraform backend"></p><h2 id=terraform-backend-について>Terraform backend について</h2><p>Terraform は、構成要素の状態を保存するために、tfstateファイルを生成します。
Terraform では、このtfstateファイルとHCL(*.tf)で記述されたコードの内容に差分があれば、それに応じて、その差分のみを更新するように振る舞います。</p><p>このtfstateファイルは、バージョン管理システム(e.g. Github)で保存することは良くないとされています。それは、以下の理由からです。</p><ol><li>tfstateファイルの追従<ul><li>以下のようなミスよって、期限切れのtfstateファイルで適用してしまう危険性がある<ul><li>バージョン管理システムへPushし忘れ<ul><li>local に最新のtfstateファイルを持ったままの状態</li></ul></li><li>2人以上のメンバーが同じtfstateファイルで同時に実行することによる競合<ul><li>バージョン管理システムの多くは、2人のメンバーが同じtfstateファイルで同時に実行することを防ぐロック(<a href=https://www.terraform.io/docs/state/locking.html>State Locking</a>)を提供していない</li></ul></li></ul></li></ul></li><li>秘匿情報<ul><li>tfstateファイルはプレーンテキストで情報を保持するので、リソースの秘匿情報が記載されてしまう<ul><li>e.g. DBのパスワード</li></ul></li></ul></li></ol><p>以上の問題から、backendリソースを使用して、tfstateファイルを外部のストレージに保存します。ここでは、AWSを使用するため、S3(tfstateファイルの保存、暗号化)+DynamoDB(State Locking)をbackendに指定します。S3のバケットはバージョニング設定ができるため、より安全な管理が行えます。</p><h2 id=terraform-backend-の管理>Terraform backend の管理</h2><p>Terraform backend は、<code>terraform init</code>時に必要となります。その為、Terraform で管理するには、AWS上に事前に作成しておき、Terraform にimportする方法が考えられます。また、外部ストレージとなるS3をTerraform で管理しているAWSアカウント上で管理することが考えられますが、公式では推奨していません。<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>
後者については、別のAWSアカウントでTerraform backend を管理することが考えられますが、前者については、Terraform で管理すると、Terraform backend を管理するための Terraform の Terraform backend について考えなければならなくなり、堂々巡りに陥ってしまったので、CloudFormation を使用して管理することにしました。</p><p><a href=https://github.com/grimoh/terraform-backend-setup-scripts>grimoh/terraform-backend-setup-scripts</a></p><p>上記のスクリプトを使用すれば、CloudFormationスタック名、S3バケット名、DynamoDBテーブル名を指定することで、Terraform backend 用のS3、DynamoDBを作成することができます。</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://www.terraform.io/docs/backends/types/s3.html>https://www.terraform.io/docs/backends/types/s3.html</a> <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></section></article><footer id=post-meta class=clearfix><a href=https://twitter.com/grim0h><img class=avatar src=https://grimoh.com/images/avatar.png><div><span class=dark>grimoh</span>
<span>I'm a visual-kei SRE.</span></div></a><section id=sharing><a class=twitter href="https://twitter.com/intent/tweet?text=https%3a%2f%2fgrimoh.com%2fpost%2fterraform-backend%2f - Terraform%20backend%20%e3%81%ae%e7%ae%a1%e7%90%86 by @grim0h"><span class=icon-twitter>tweet</span></a>
<a class=facebook href=# onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),'facebook-share-dialog','width=626,height=436');return false;"><span class=icon-facebook-rect>Share</span></a></section></footer><ul id=post-list class="archive readmore"><h3>Read more</h3><li><a href=https://grimoh.com/post/skillmap/>個人活動におけるスキルマップのすすめ<aside class=dates>Oct 21 2019</aside></a></li><li><a href=https://grimoh.com/post/asdf-vm/>asdf-vm を使用したバージョン管理<aside class=dates>Jul 18 2019</aside></a></li><li><a href=https://grimoh.com/post/first_post/>First post<aside class=dates>Mar 24 2019</aside></a></li></ul><footer id=footer><div id=social><a class=symbol href=https://www.github.com/grimoh><i class="fa fa-github"></i></a><a class=symbol href=https://www.twitter.com/grim0h><i class="fa fa-twitter"></i></a></div><p class=small>© Copyright 2020 grimoh</p></footer></section><script src=//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js></script><script src=https://grimoh.com/js/main.js></script><script src=https://grimoh.com/js/highlight.js></script><script>hljs.initHighlightingOnLoad();</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-137907582-1','auto');ga('send','pageview');}</script></body></html>